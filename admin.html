<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gxyenn Store</title>
    <link rel="icon" type="image/png" href="https://cloudkuimages.guru/uploads/images/684c97244c279.png">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a202c; color: #e2e8f0; margin: 0; padding: 10px; box-sizing: border-box; }
        .container { max-width: 100%; margin: auto; background-color: #2d3748; padding: 15px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        h1 { color: #63b3ed; text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid #4a5568; padding: 8px 10px; text-align: left; font-size: 0.85rem; word-wrap: break-word; overflow-wrap: break-word; }
        th { background-color: #434190; color: white; white-space: nowrap; }
        td { vertical-align: middle; }
        td.actions-cell, td.proof-cell { white-space: nowrap; text-align: center; }
        tr:nth-child(even) { background-color: #374151; }
        tr:hover { background-color: #4a55687d; }
        button { background-color: #38a169; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s; }
        button:hover { background-color: #2f855a; }
        button.approve-btn[disabled] { background-color: #718096; cursor: not-allowed; }
        .logout-btn { background-color: #c53030; float: right; margin-bottom:10px; }
        .logout-btn:hover { background-color: #9b2c2c; }
        .status-pending { color: #f6e05e; font-weight: bold; }
        .status-approved { color: #68d391; font-weight: bold; }
        .status-rejected { color: #fc8181; font-weight: bold; }
        .filter-controls { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .filter-controls label { font-size: 0.85rem; margin-right: 5px; }
        .filter-controls select, .filter-controls button { padding: 7px; border-radius: 5px; border: 1px solid #4a5568; background-color: #1a202c; color: #e2e8f0; font-size: 0.85rem; }
        .pagination-controls { margin-top: 15px; text-align: center; }
        .pagination-controls button { margin: 0 4px; background-color: #4c51bf; }
        .pagination-controls button:disabled { background-color: #718096; }
        .pagination-controls span { font-size: 0.9rem; margin: 0 10px; }
        .proof-link { color: #63b3ed; text-decoration: none; font-weight: 500; }
        .proof-link:hover { text-decoration: underline; }
        table th:nth-child(1), table td:nth-child(1) { width: 8%; } 
        table th:nth-child(2), table td:nth-child(2) { width: 10%; } 
        table th:nth-child(3), table td:nth-child(3) { width: 18%; } 
        table th:nth-child(4), table td:nth-child(4) { width: 25%; } 
        table th:nth-child(5), table td:nth-child(5) { width: 10%; } 
        table th:nth-child(6), table td:nth-child(6) { width: 10%; text-align: center;} 
        table th:nth-child(7), table td:nth-child(7) { width: 9%; text-align: center;} 
        table th:nth-child(8), table td:nth-child(8) { width: 10%; text-align: center;}
        .modal { display:none; position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1001;justify-content:center;align-items:center; flex-direction:column; }
        .modal-content { background:#2d3748; padding:25px; border-radius:8px; width:90%; max-width:480px; color: #e2e8f0; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { color:#63b3ed; margin-top:0; margin-bottom: 15px; }
        .modal-content p { margin-bottom: 10px; }
        .modal-content .form-group { margin-bottom:12px; }
        .modal-content .form-group label { display:block; margin-bottom:5px; font-size:0.9rem; color: #a0aec0; }
        .modal-content .form-group input[type="url"] {
            width: calc(100% - 16px); padding:8px; border-radius:4px; border:1px solid #4a5568; background:#1a202c; color:#e2e8f0; font-size:0.9rem;
        }
        .modal-footer { text-align:right; margin-top:20px; }
        .modal-footer button { padding: 8px 15px; font-size: 0.85rem; }
        .modal-footer button.cancel-btn { background-color:#718096; margin-right:10px; }
        .modal-footer button.cancel-btn:hover { background-color:#5a6678; }
        .modal-footer button.confirm-btn { background-color:#38a169; }
        .modal-footer button.confirm-btn:hover { background-color:#2f855a; }
        #approvalNote { font-size:0.8rem; color:#a0aec0; margin-top: 10px; }
        @media (max-width: 768px) {
            h1 { font-size: 1.3rem; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            .filter-controls select, .filter-controls button { width: 100%; }
            body { padding: 5px; }
            .container { padding: 10px; }
            .modal-content { padding: 20px; max-width: 95%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="logoutButton" class="logout-btn">Logout Admin</button>
        <h1>Admin Dashboard - Pesanan</h1>

        <div class="filter-controls">
            <label for="statusFilter">Filter Status:</label>
            <select id="statusFilter">
                <option value="">Semua</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
            <button id="applyFilterButton">Terapkan Filter</button>
        </div>
        
        <div class="table-wrapper">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>ID Pesan</th>
                        <th>Tanggal</th>
                        <th>User (Toko)</th>
                        <th>Produk</th>
                        <th>Harga</th>
                        <th>Status</th>
                        <th>Bukti / Detail Ptero</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="pagination-controls">
            <button id="prevPageButton" disabled>Sebelumnya</button>
            <span id="pageInfo">Halaman 1 dari 1</span>
            <button id="nextPageButton" disabled>Berikutnya</button>
        </div>
    </div>

    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <h3 id="approvalModalTitle">Konfirmasi Persetujuan</h3>
            <p>Produk: <strong id="approvalModalProductName"></strong></p>
            <p>User: <strong id="approvalModalUserEmail"></strong></p>
            <div id="approvalFormInputsContainer">
            </div>
            <p id="approvalNote" style="font-size:0.8rem; color:#a0aec0;"></p>
            <div class="modal-footer">
                <button id="cancelApprovalButton" class="cancel-btn">Batal</button>
                <button id="confirmApprovalButton" class="confirm-btn">Setujui & Proses</button>
            </div>
        </div>
    </div>

    <script>
        const ordersTableBody = document.querySelector('#ordersTable tbody');
        const logoutButton = document.getElementById('logoutButton');
        const statusFilterSelect = document.getElementById('statusFilter');
        const applyFilterButton = document.getElementById('applyFilterButton');
        const prevPageButton = document.getElementById('prevPageButton');
        const nextPageButton = document.getElementById('nextPageButton');
        const pageInfoSpan = document.getElementById('pageInfo');

        const approvalModal = document.getElementById('approvalModal');
        const approvalModalTitle = document.getElementById('approvalModalTitle');
        const approvalModalProductName = document.getElementById('approvalModalProductName');
        const approvalModalUserEmail = document.getElementById('approvalModalUserEmail');
        const approvalFormInputsContainer = document.getElementById('approvalFormInputsContainer');
        const approvalNote = document.getElementById('approvalNote');
        const confirmApprovalButton = document.getElementById('confirmApprovalButton');
        const cancelApprovalButton = document.getElementById('cancelApprovalButton');

        let currentPage = 1;
        let totalPages = 1;
        const limit = 10;
        let currentOrderForApproval = null;
        let currentApproveButtonElement = null;
        const TOKEN_KEY = 'gxyennToken'; 

        async function verifyAdminAccessAndLoadData() {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                alert('Sesi tidak ditemukan. Silakan login sebagai admin.');
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/auth/status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    localStorage.removeItem(TOKEN_KEY);
                    alert('Sesi tidak valid atau telah berakhir. Silakan login kembali.');
                    window.location.href = '/login';
                    return;
                }

                const authData = await response.json();
                if (!authData.isLoggedIn || !authData.user || authData.user.role !== 'admin') {
                    localStorage.removeItem(TOKEN_KEY);
                    alert('Akses ditolak. Anda bukan admin atau sesi telah berakhir.');
                    window.location.href = '/login';
                    return;
                }
                
                fetchOrders(currentPage, statusFilterSelect.value);

            } catch (error) {
                console.error('Error verifying admin access:', error);
                localStorage.removeItem(TOKEN_KEY);
                alert('Terjadi kesalahan saat verifikasi admin. Silakan coba login lagi.');
                window.location.href = '/login';
            }
        }


        async function fetchOrders(page = 1, status = '') {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) { 
                return; 
            }
            try {
                ordersTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Memuat data pesanan...</td></tr>`;
                const response = await fetch(`/api/admin/orders?page=${page}&limit=${limit}&status=${status}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    alert('Akses ditolak atau sesi berakhir. Silakan login sebagai admin.');
                    localStorage.removeItem(TOKEN_KEY);
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal mengambil data pesanan.');
                }
                const data = await response.json();
                renderOrders(data.orders);
                currentPage = data.currentPage;
                totalPages = data.totalPages;
                updatePaginationControls();
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color: #fc8181;">Error: ${error.message}</td></tr>`;
            }
        }

        function renderOrders(orders) {
            ordersTableBody.innerHTML = '';
            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Tidak ada pesanan ditemukan.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = ordersTableBody.insertRow();
                row.insertCell().textContent = order._id.slice(-6);
                row.insertCell().textContent = new Date(order.createdAt).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'2-digit'});
                
                let userDisplay = 'N/A';
                if (order.user) { 
                    userDisplay = `${order.user.firstName} (${order.user.email.substring(0, Math.min(10, order.user.email.indexOf('@')))}...)`;
                } else if (order.userEmailDisplay) { 
                     userDisplay = `Guest (${order.userEmailDisplay.substring(0, Math.min(10, order.userEmailDisplay.indexOf('@')))}...)`;
                }
                row.insertCell().textContent = userDisplay;
                
                row.insertCell().textContent = order.productName;
                row.insertCell().textContent = order.productPriceFormatted;
                const statusCell = row.insertCell();
                statusCell.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
                statusCell.className = `status-${order.status}`;
                
                const proofOrDetailCell = row.insertCell();
                proofOrDetailCell.classList.add('proof-cell'); 
                if (order.paymentProofPath) {
                    const proofLink = document.createElement('a');
                    proofLink.href = order.paymentProofPath.startsWith('http') ? order.paymentProofPath : `${order.paymentProofPath}`;
                    proofLink.textContent = 'Bukti Bayar';
                    proofLink.target = '_blank';
                    proofLink.className = 'proof-link';
                    proofOrDetailCell.appendChild(proofLink);
                } else {
                     proofOrDetailCell.textContent = '-';
                }
                if (order.pteroUserEmail) {
                    const pteroInfo = document.createElement('div');
                    pteroInfo.style.fontSize = '0.75rem';
                    pteroInfo.style.marginTop = '3px';
                    pteroInfo.style.color = '#a0aec0';
                    pteroInfo.textContent = `Ptero Email: ${order.pteroUserEmail.substring(0, Math.min(10, order.pteroUserEmail.indexOf('@')))}...`;
                     if (order.pteroUsername) {
                         pteroInfo.textContent += ` | User: ${order.pteroUsername}`;
                     }
                    proofOrDetailCell.appendChild(pteroInfo);
                }


                const actionCell = row.insertCell();
                actionCell.classList.add('actions-cell');
                if (order.status === 'pending') {
                    const approveButton = document.createElement('button');
                    approveButton.textContent = 'Setujui';
                    approveButton.classList.add('approve-btn');
                    approveButton.onclick = () => openApprovalModal(order, approveButton);
                    actionCell.appendChild(approveButton);
                } else {
                    actionCell.textContent = 'Diproses';
                }
            });
        }
        
        function updatePaginationControls() {
            pageInfoSpan.textContent = `Hal ${currentPage} dari ${totalPages}`;
            prevPageButton.disabled = currentPage <= 1;
            nextPageButton.disabled = currentPage >= totalPages;
        }

        function openApprovalModal(order, buttonElement) {
            currentOrderForApproval = order;
            currentApproveButtonElement = buttonElement;
            approvalModalProductName.textContent = order.productName;
            approvalModalUserEmail.textContent = order.user ? order.user.email : (order.userEmailDisplay || 'N/A');
            approvalFormInputsContainer.innerHTML = ''; 
            approvalNote.textContent = '';
            confirmApprovalButton.disabled = false;
            confirmApprovalButton.textContent = 'Setujui & Proses';

            const orderProductNameLower = order.productName.toLowerCase();
            const productType = order.productType || 
                                (orderProductNameLower.includes('reseller panel') ? 'reseller' : 
                                (orderProductNameLower.includes('admin panel') ? 'pterodactyl_admin' :
                                (orderProductNameLower.includes('panel ram') ? 'pterodactyl' : 'generic')));


            if (productType === 'pterodactyl' || productType === 'pterodactyl_admin') {
                approvalModalTitle.textContent = 'Konfirmasi Pembuatan Panel Pterodactyl';
                approvalFormInputsContainer.innerHTML = `<p>Akun Pterodactyl akan dibuat/digunakan berdasarkan data yang diinput pengguna saat pemesanan.</p>
                                                       <p>Server akan otomatis dibuat sesuai spesifikasi produk.</p>`;
                approvalNote.textContent = "Pastikan integrasi Pterodactyl di backend sudah benar. Info login akan dikirim ke email Pterodactyl pengguna.";
            } else if (productType === 'reseller') {
                approvalModalTitle.textContent = 'Input Link Grup Reseller';
                approvalFormInputsContainer.innerHTML = `
                    <div class="form-group">
                        <label for="resellerGroupLink">Link Grup Reseller (WA/TG):</label>
                        <input type="url" id="resellerGroupLink" placeholder="https://chat.whatsapp.com/..." required value="${order.pendingResellerLink || ''}">
                    </div>
                `;
                approvalNote.textContent = "Link ini akan dikirimkan ke pelanggan untuk bergabung.";
            } else {
                approvalModalTitle.textContent = 'Konfirmasi Persetujuan';
                approvalFormInputsContainer.innerHTML = `<p>Anda yakin ingin menyetujui pesanan umum ini?</p>`;
                approvalNote.textContent = "Notifikasi dasar akan dikirim ke pelanggan.";
            }
            approvalModal.style.display = 'flex';
        }

        cancelApprovalButton.onclick = () => {
            approvalModal.style.display = 'none';
            currentOrderForApproval = null;
            if (currentApproveButtonElement) {
                currentApproveButtonElement.disabled = false;
                currentApproveButtonElement.textContent = 'Setujui';
            }
            currentApproveButtonElement = null;
        };

        confirmApprovalButton.onclick = () => {
            if (currentOrderForApproval && currentApproveButtonElement) {
                processApproveOrder();
            }
        };
        
        async function processApproveOrder() {
            const order = currentOrderForApproval;
            const button = currentApproveButtonElement;
            const orderId = order._id;
            const token = localStorage.getItem(TOKEN_KEY);

            let approvalPayload = { 
                productType: order.productType || 'generic'
            }; 
            let alertMessageAction = "disetujui";
            
            const orderProductNameLower = order.productName.toLowerCase();
            if (!approvalPayload.productType || approvalPayload.productType === 'generic') {
                 approvalPayload.productType = (orderProductNameLower.includes('reseller panel') ? 'reseller' : 
                                (orderProductNameLower.includes('admin panel') ? 'pterodactyl_admin' :
                                (orderProductNameLower.includes('panel ram') ? 'pterodactyl' : 'generic')));
            }


            if (approvalPayload.productType === 'pterodactyl' || approvalPayload.productType === 'pterodactyl_admin') {
                alertMessageAction = "disetujui dan panel Pterodactyl akan dibuat otomatis";
            } else if (approvalPayload.productType === 'reseller') {
                const resellerGroupLinkInput = document.getElementById('resellerGroupLink');
                if (resellerGroupLinkInput) {
                    const resellerGroupLink = resellerGroupLinkInput.value.trim();
                    if (!resellerGroupLink) {
                        alert('Link grup reseller harus diisi.');
                        return;
                    }
                    approvalPayload.resellerGroupLink = resellerGroupLink;
                    alertMessageAction = "disetujui dan link reseller dikirim";
                } else {
                     alertMessageAction = "disetujui (reseller tanpa link spesifik)";
                }
            }
            
            button.disabled = true;
            button.textContent = 'Memproses...';
            confirmApprovalButton.disabled = true;
            confirmApprovalButton.textContent = 'Memproses...';

            try {
                const response = await fetch(`/api/admin/orders/${orderId}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalPayload)
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Pesanan ${orderId.slice(-6)} berhasil ${alertMessageAction}.`);
                    approvalModal.style.display = 'none';
                    fetchOrders(currentPage, statusFilterSelect.value);
                } else {
                    alert(`Gagal menyetujui: ${data.message || 'Terjadi kesalahan.'}`);
                    button.disabled = false;
                    button.textContent = 'Setujui';
                }
            } catch (error) {
                console.error('Error approving order:', error);
                alert('Terjadi kesalahan saat menyetujui pesanan.');
                button.disabled = false;
                button.textContent = 'Setujui';
            } finally {
                confirmApprovalButton.disabled = false; 
            }
        }
        
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem(TOKEN_KEY);
            alert('Admin logout berhasil.');
            window.location.href = '/login';
        });

        applyFilterButton.addEventListener('click', () => {
            currentPage = 1;
            fetchOrders(currentPage, statusFilterSelect.value);
        });
        
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                 currentPage--;
                 fetchOrders(currentPage, statusFilterSelect.value);
            }
        });

        nextPageButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchOrders(currentPage, statusFilterSelect.value);
            }
        });

        document.addEventListener('DOMContentLoaded', verifyAdminAccessAndLoadData);
    </script>
</body>
</html>